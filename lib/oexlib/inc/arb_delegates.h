/*------------------------------------------------------------------
// arb_delegates.h
//
// Copyright (c) 1997
// Robert Umbehant
// winglib@wheresjames.com
// http://www.wheresjames.com
//
// Redistribution and use in source and binary forms, with or 
// without modification, are permitted for commercial and 
// non-commercial purposes, provided that the following 
// conditions are met:
//
// * Redistributions of source code must retain the above copyright 
//   notice, this list of conditions and the following disclaimer.
// * The names of the developers or contributors may not be used to 
//   endorse or promote products derived from this software without 
//   specific prior written permission.
//
//   THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND 
//   CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, 
//   INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF 
//   MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE 
//   DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR 
//   CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, 
//   SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT 
//   NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; 
//   LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) 
//   HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN 
//   CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR 
//   OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, 
//   EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
//----------------------------------------------------------------*/

#define TARB_PARAM_A_0      
#define TARB_PARAM_B_0      
#define TARB_PARAM_C_0      
#define TARB_PARAM_D_0      
#define TARB_PARAM_E_0      
#define TARB_PARAM_F_0      
#define TARB_PARAM_G_0      
#define TARB_PARAM_H_0      
#define TARB_PARAM_I_0

#define TARB_PARAM_A_1      typename T_P1,
#define TARB_PARAM_B_1      T_P1
#define TARB_PARAM_C_1      , T_P1
#define TARB_PARAM_D_1      T_P1,
#define TARB_PARAM_E_1      T_ARB p1
#define TARB_PARAM_F_1      , T_ARB p1
#define TARB_PARAM_G_1      , p1
#define TARB_PARAM_H_1      p1
#define TARB_PARAM_I_1      , T_ARB

#define TARB_PARAM_A_2      typename T_P1, typename T_P2,
#define TARB_PARAM_B_2      T_P1, T_P2
#define TARB_PARAM_C_2      , T_P1, T_P2
#define TARB_PARAM_D_2      T_P1, T_P2,
#define TARB_PARAM_E_2      T_ARB p1, T_ARB p2
#define TARB_PARAM_F_2      , T_ARB p1, T_ARB p2
#define TARB_PARAM_G_2      , p1, p2
#define TARB_PARAM_H_2      p1, p2
#define TARB_PARAM_I_2      , T_ARB, T_ARB

#define TARB_PARAM_A_3      typename T_P1, typename T_P2, typename T_P3,
#define TARB_PARAM_B_3      T_P1, T_P2, T_P3
#define TARB_PARAM_C_3      , T_P1, T_P2, T_P3
#define TARB_PARAM_D_3      T_P1, T_P2, T_P3,
#define TARB_PARAM_E_3      T_ARB p1, T_ARB p2, T_ARB p3
#define TARB_PARAM_F_3      , T_ARB p1, T_ARB p2, T_ARB p3
#define TARB_PARAM_G_3      , p1, p2, p3
#define TARB_PARAM_H_3      p1, p2, p3
#define TARB_PARAM_I_3      , T_ARB, T_ARB, T_ARB

#define TARB_PARAM_A_4      typename T_P1, typename T_P2, typename T_P3, typename T_P4,
#define TARB_PARAM_B_4      T_P1, T_P2, T_P3, T_P4
#define TARB_PARAM_C_4      , T_P1, T_P2, T_P3, T_P4
#define TARB_PARAM_D_4      T_P1, T_P2, T_P3, T_P4,
#define TARB_PARAM_E_4      T_ARB p1, T_ARB p2, T_ARB p3, T_ARB p4
#define TARB_PARAM_F_4      , T_ARB p1, T_ARB p2, T_ARB p3, T_ARB p4
#define TARB_PARAM_G_4      , p1, p2, p3, p4
#define TARB_PARAM_H_4      p1, p2, p3, p4
#define TARB_PARAM_I_4      , T_ARB, T_ARB, T_ARB, T_ARB

#define TARB_PARAM_A_5      typename T_P1, typename T_P2, typename T_P3, typename T_P4, typename T_P5,
#define TARB_PARAM_B_5      T_P1, T_P2, T_P3, T_P4, T_P5
#define TARB_PARAM_C_5      , T_P1, T_P2, T_P3, T_P4, T_P5
#define TARB_PARAM_D_5      T_P1, T_P2, T_P3, T_P4, T_P5,
#define TARB_PARAM_E_5      T_ARB p1, T_ARB p2, T_ARB p3, T_ARB p4, T_ARB p5
#define TARB_PARAM_F_5      , T_ARB p1, T_ARB p2, T_ARB p3, T_ARB p4, T_ARB p5
#define TARB_PARAM_G_5      , p1, p2, p3, p4, p5
#define TARB_PARAM_H_5      p1, p2, p3, p4, p5
#define TARB_PARAM_I_5      , T_ARB, T_ARB, T_ARB, T_ARB, T_ARB

#define TARB_PARAM_A_6      typename T_P1, typename T_P2, typename T_P3, typename T_P4, typename T_P5, typename T_P6,
#define TARB_PARAM_B_6      T_P1, T_P2, T_P3, T_P4, T_P5, T_P6
#define TARB_PARAM_C_6      , T_P1, T_P2, T_P3, T_P4, T_P5, T_P6
#define TARB_PARAM_D_6      T_P1, T_P2, T_P3, T_P4, T_P5, T_P6,
#define TARB_PARAM_E_6      T_ARB p1, T_ARB p2, T_ARB p3, T_ARB p4, T_ARB p5, T_ARB p6
#define TARB_PARAM_F_6      , T_ARB p1, T_ARB p2, T_ARB p3, T_ARB p4, T_ARB p5, T_ARB p6
#define TARB_PARAM_G_6      , p1, p2, p3, p4, p5, p6
#define TARB_PARAM_H_6      p1, p2, p3, p4, p5, p6
#define TARB_PARAM_I_6      , T_ARB, T_ARB, T_ARB, T_ARB, T_ARB, T_ARB

// Delegate function body
#define TARB_BODY( n )                                                                                  \
public:                                                                                                 \
    template < typename T_RET, TARB_PARAM_A_##n typename T_CLASS >                                      \
        TArbDelegate( T_CLASS *x_pC, T_RET(T_CLASS::*x_pF)( TARB_PARAM_B_##n ) )                        \
    {   TArbDelegate(); _Register< T_RET TARB_PARAM_C_##n >( x_pC, x_pF ); }                            \
    template < typename T_RET, TARB_PARAM_A_##n typename T_CLASS >                                      \
        void Register( T_CLASS *x_pC, T_RET(T_CLASS::*x_pF)( TARB_PARAM_B_##n ) )                       \
    {   _Register< T_RET TARB_PARAM_C_##n >( x_pC, x_pF ); }                                            \
    T_ARB operator ()( TARB_PARAM_E_##n )                                                               \
    {   typedef T_ARB (*t_Thunk)( void*, void* TARB_PARAM_I_##n );                                      \
        return ((t_Thunk)m_pThunk)( m_pClass, &m_rawFunction TARB_PARAM_G_##n ); }                      \
private:                                                                                                \
    template < typename T_RET, TARB_PARAM_A_##n typename T_CLASS, typename T_FUNCTION >                 \
        void _Register( T_CLASS *x_pC, T_FUNCTION x_pF )                                                \
    {   m_uParams = n;                                                                                  \
        m_pClass = x_pC;                                                                                \
        *(T_FUNCTION*)(void*)m_rawFunction = x_pF;                                                      \
        typedef T_ARB (*t_Thunk)( void*, void* TARB_PARAM_I_##n );                                      \
        m_pThunk = (t_Thunk)&SThunk_##n< T_RET >::Thunk< T_RET, TARB_PARAM_D_##n T_CLASS, T_FUNCTION >; \
    }                                                                                                   \
    template< typename T_RET > struct SThunk_##n                                                        \
    {   template < typename T_RET, TARB_PARAM_A_##n typename T_CLASS, typename T_FUNCTION >             \
            static T_ARB Thunk( void* x_pC, void* x_pF TARB_PARAM_F_##n )                               \
        {   return ( ( (T_CLASS*)x_pC )->*( *( (T_FUNCTION*)x_pF ) ) )( TARB_PARAM_H_##n ); }           \
    };                                                                                                  \
    template <> struct SThunk_##n< void >                                                               \
    {   template < typename T_RET, TARB_PARAM_A_##n typename T_CLASS, typename T_FUNCTION >             \
            static T_ARB Thunk( void* x_pC, void* x_pF TARB_PARAM_F_##n )                               \
        {   ( ( (T_CLASS*)x_pC )->*( *( (T_FUNCTION*)x_pF ) ) )( TARB_PARAM_H_##n ); return 0; }       \
    };


template < typename T_ARB >
    class TArbDelegate
{
public:

    /// Constructor
    TArbDelegate()
    {   m_uParams = 0;
        m_pClass = m_pThunk = 0;        
        *(__int64*)m_rawFunction = 0;
        *(__int64*)&m_rawFunction[ 8 ] = 0;
    }

    /// Copy constructor
    TArbDelegate( TArbDelegate &x_rD )
    {   m_uParams = x_rD.m_uParams;
        m_pClass = x_rD.m_pClass;
        m_pThunk = x_rD.m_pThunk;
        *(__int64*)m_rawFunction = *(__int64*)x_rD.m_rawFunction;
        *(__int64*)&m_rawFunction[ 8 ] = *(__int64*)&x_rD.m_rawFunction[ 8 ];
    }

    /// Copy constructor
    TArbDelegate& operator = ( TArbDelegate &x_rD )
    {   m_uParams = x_rD.m_uParams;
        m_pClass = x_rD.m_pClass;
        m_pThunk = x_rD.m_pThunk;
        *(__int64*)m_rawFunction = *(__int64*)x_rD.m_rawFunction;
        *(__int64*)&m_rawFunction[ 8 ] = *(__int64*)&x_rD.m_rawFunction[ 8 ];
        return *this;
    }

    // For each possible number of parameters
    TARB_BODY( 0 );
    TARB_BODY( 1 );
    TARB_BODY( 2 );
    TARB_BODY( 3 );
    TARB_BODY( 4 );
    TARB_BODY( 5 );
    TARB_BODY( 6 );

public:

    /// Returns the number of parameters the function has
    unsigned int GetNumParams()
    {   return m_uParams; }

    /// Returns non-zero if the delegate appears to be set
    unsigned int IsValid()
    {   return 0 != m_pThunk; }

protected:

    /// Class pointer
    void*                   m_pClass;

    /// Function pointer buffer
    char                    m_rawFunction[ 16 ];

    /// Thunk
    void*                   m_pThunk;

    /// Number of params
    unsigned int            m_uParams;
};

